<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISCO - Registro Facial</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.1/dist/face-api.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen" style="background-image: url('https://i.imgur.com/Z9PMZoP.jpeg'); background-size: cover; background-position: center;">
    <div class="bg-white/80 p-8 md:p-12 rounded-2xl shadow-xl max-w-xl w-full text-center">
        <h1 class="text-4xl font-bold text-[#006400] mb-1">SISCO</h1>
        <p class="text-[#006400] mb-0 text-lg">(Sistema de Identificación Segura CONALEP)</p>
        <p class="text-black mb-0 text-lg font-bold">Plantel NAVOLATO 115</p>
        <p class="text-black mb-6 text-lg font-bold">Registro de Alumnos</p>

        <!-- Contenedor principal de la app -->
        <div id="app-container">
            <!-- El contenido se cargará aquí dinámicamente -->
        </div>

        <!-- Mensajes de la app -->
        <div id="message-box" class="min-h-[4rem] flex items-center justify-center p-4 rounded-lg font-medium transition-all duration-300 text-sm mt-4 text-blue-700 bg-blue-100 border border-blue-200">
            <span>Cargando modelos de IA...</span>
        </div>

        <p class="mt-6 text-xs text-gray-500 text-center">App creada por: Nick Monarrez</p>
    </div>

    <script>
        // Credenciales y URLs
        const NOMBRE_USUARIO_CORRECTO = 'ConalepNAVOLATO115*';
        const CONTRASENA_CORRECTA = 'Orientacioneducativa115*';
        const URL_MODELOS = 'https://raw.githubusercontent.com/NickMonarrez/aplicacion-asistencia/main/modelos';
        // ¡¡IMPORTANTE!! Debes reemplazar esta URL con la de tu despliegue de Google Apps Script.
        const URL_APP_SCRIPT = 'https://script.google.com/macros/s/AKfycby6Rk_xeV17Y8O9Lc0_7Lbwbc38nVGNwyvk4FUmjBdYbqqd8FhOV6evRAva9RlHoveC/exec';

        // Elementos del DOM
        const contenedorApp = document.getElementById('app-container');
        const cajaMensaje = document.getElementById('message-box');

        // Estado de la aplicación
        let sesionIniciada = false;
        let idAlumno = '';
        let nombreAlumno = null;
        let streamVideo = null;
        let cargando = true;
        
        // Funciones para la interfaz de usuario
        function mostrarMensaje(msg, tipo) {
            let colorFondo = 'bg-blue-100 text-blue-700 border-blue-200';
            if (tipo === 'success') {
                colorFondo = 'bg-green-100 text-green-700 border-green-200';
            } else if (tipo === 'error') {
                colorFondo = 'bg-red-100 text-red-700 border-red-200';
            }
            cajaMensaje.className = `min-h-[4rem] flex items-center justify-center p-4 rounded-lg font-medium transition-all duration-300 text-sm mt-4 border ${colorFondo}`;
            cajaMensaje.querySelector('span').textContent = msg;
        }

        function renderizarLogin() {
            contenedorApp.innerHTML = `
                <div class="transition-all duration-300">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-800">Iniciar Sesión</h2>
                    <input type="text" placeholder="Usuario" class="w-full p-3 mb-4 text-center text-lg rounded-xl border-2 border-gray-300 focus:outline-none focus:border-blue-500 transition-all duration-300" id="input-usuario" />
                    <input type="password" placeholder="Contraseña" class="w-full p-3 mb-4 text-center text-lg rounded-xl border-2 border-gray-300 focus:outline-none focus:border-blue-500 transition-all duration-300" id="input-contrasena" />
                    <button onclick="manejarLogin()" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-xl transition-all duration-300">Acceder</button>
                </div>
            `;
        }

        function renderizarAppPrincipal() {
            contenedorApp.innerHTML = `
                <div class="transition-all duration-300">
                    <div id="contenedor-input-id">
                        <input type="text" placeholder="Ingresa el ID del alumno" class="w-full p-3 mb-4 text-center text-lg rounded-xl border-2 border-gray-300 focus:outline-none focus:border-blue-500 transition-all duration-300" id="input-id-alumno" value="${idAlumno}" />
                        <button onclick="verificarId()" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-xl transition-all duration-300">Verificar ID</button>
                    </div>
                    <div id="contenedor-video" class="relative w-full aspect-video overflow-hidden rounded-xl shadow-inner mb-6 bg-gray-200 flex items-center justify-center border-4 border-gray-300 hidden">
                        <video id="elemento-video" autoPlay muted playsInline class="w-full h-full object-cover rounded-xl"></video>
                    </div>
                    <button onclick="reiniciarApp()" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-xl transition-all duration-300 mt-4 hidden" id="boton-cancelar">Cancelar</button>
                    <button onclick="cerrarSesion()" class="mt-4 w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-xl transition-all duration-300">Cerrar Sesión</button>
                </div>
            `;
            // Asegurarse de que el input tenga el valor correcto
            document.getElementById('input-id-alumno').value = idAlumno;
        }

        function renderizarCargando() {
            contenedorApp.innerHTML = `
                <div class="loader flex flex-col items-center justify-center p-6 rounded-xl shadow-lg">
                    <svg class="animate-spin -ml-1 mr-3 h-8 w-8 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span>${cajaMensaje.querySelector('span').textContent}</span>
                </div>
            `;
        }

        // Funciones de la aplicación
        function manejarLogin() {
            const usuario = document.getElementById('input-usuario').value;
            const contrasena = document.getElementById('input-contrasena').value;
            if (usuario === NOMBRE_USUARIO_CORRECTO && contrasena === CONTRASENA_CORRECTA) {
                sesionIniciada = true;
                mostrarMensaje('Credenciales correctas. Iniciando aplicación...', 'success');
                idAlumno = '';
                renderizarAppPrincipal();
            } else {
                mostrarMensaje('Usuario o contraseña incorrectos.', 'error');
            }
        }

        async function verificarId() {
            const idIngresado = document.getElementById('input-id-alumno').value;
            if (!idIngresado) {
                mostrarMensaje('Por favor, ingresa un ID válido.', 'error');
                return;
            }
            idAlumno = idIngresado;
            mostrarMensaje('Verificando ID...', 'info');
            try {
                const respuesta = await fetch(`${URL_APP_SCRIPT}?studentId=${encodeURIComponent(idIngresado)}`);
                const datos = await respuesta.json();
                if (datos && datos.success) {
                    nombreAlumno = datos.name; // Almacena el nombre del alumno
                    mostrarMensaje(`¡Hola, ${nombreAlumno}! Por favor, mira a la cámara para registrar tu rostro.`, 'success');
                    document.getElementById('contenedor-input-id').classList.add('hidden');
                    document.getElementById('contenedor-video').classList.remove('hidden');
                    document.getElementById('boton-cancelar').classList.remove('hidden');
                    iniciarVideo();
                } else {
                    mostrarMensaje(datos.message || 'Error al verificar el ID. Intenta de nuevo.', 'error');
                }
            } catch (e) {
                console.error("Error al verificar el ID:", e);
                mostrarMensaje(`Error de conexión: ${e.message}.`, 'error');
            }
        }

        async function iniciarVideo() {
            try {
                const elementoVideo = document.getElementById('elemento-video');
                streamVideo = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
                elementoVideo.srcObject = streamVideo;
                elementoVideo.play();
                elementoVideo.onloadedmetadata = () => {
                    setInterval(detectarRostro, 500);
                };
            } catch (err) {
                console.error("Error al acceder a la cámara:", err);
                mostrarMensaje('No se pudo acceder a la cámara. Concede los permisos.', 'error');
            }
        }

        async function detectarRostro() {
            const elementoVideo = document.getElementById('elemento-video');
            if (!elementoVideo || elementoVideo.readyState !== 4) return;
            try {
                const detecciones = await faceapi.detectSingleFace(elementoVideo, new faceapi.TinyFaceDetectorOptions())
                    .withFaceLandmarks()
                    .withFaceDescriptor();

                if (detecciones && detecciones.descriptor) {
                    mostrarMensaje(`Rostro de ${nombreAlumno} detectado. Registrando...`, 'info');
                    registrarDescriptorFacial(detecciones.descriptor);
                }
            } catch (e) {
                console.error("Error durante la detección de rostro:", e);
                mostrarMensaje(`Error durante la detección: ${e.message}.`, 'error');
            }
        }

        async function registrarDescriptorFacial(descriptor) {
            try {
                const respuesta = await fetch(URL_APP_SCRIPT, {
                    method: 'POST',
                    body: JSON.stringify({
                        idAlumno: idAlumno,
                        descriptor: JSON.stringify(Array.from(descriptor)),
                    }),
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });

                const datos = await respuesta.json();
                if (!datos.success) {
                    throw new Error(datos.message);
                }
                mostrarMensaje(`¡Rasgos faciales de ${nombreAlumno} registrados con éxito! ✅`, 'success');
                setTimeout(reiniciarApp, 3000);
            } catch (e) {
                console.error("Error al registrar el descriptor facial:", e);
                mostrarMensaje(`Error al registrar el rostro: ${e.message}.`, 'error');
                setTimeout(reiniciarApp, 3000);
            }
        }

        function reiniciarApp() {
            if (streamVideo) {
                streamVideo.getTracks().forEach(track => track.stop());
            }
            document.getElementById('contenedor-input-id').classList.remove('hidden');
            document.getElementById('contenedor-video').classList.add('hidden');
            document.getElementById('boton-cancelar').classList.add('hidden');
            idAlumno = '';
            nombreAlumno = null;
            mostrarMensaje('Ingresa un ID para comenzar.', 'info');
            renderizarAppPrincipal();
        }

        function cerrarSesion() {
            sesionIniciada = false;
            mostrarMensaje('Por favor, ingresa tus credenciales.');
            renderizarLogin();
        }

        // Inicialización de la app
        window.onload = async () => {
            renderizarCargando();
            await faceapi.nets.tinyFaceDetector.loadFromUri(URL_MODELOS);
            await faceapi.nets.faceLandmark68Net.loadFromUri(URL_MODELOS);
            await faceapi.nets.faceRecognitionNet.loadFromUri(URL_MODELOS);
            cargando = false;
            mostrarMensaje('Modelos de IA cargados. Ingresa tus credenciales.');
            renderizarLogin();
        };

    </script>
</body>
</html>

