<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Descriptores Faciales por ID</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-image: url('https://i.imgur.com/Z9PMZoP.jpeg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
        }
        #video-feed {
            display: block;
            transform: scaleX(-1);
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <div class="bg-white/80 p-8 md:p-12 rounded-2xl shadow-xl max-w-xl w-full text-center">
        <h1 class="text-4xl font-bold text-[#006400] mb-1">SISCO</h1>
        <p class="text-[#006400] mb-0 text-lg">(Sistema de Identificación Segura CONALEP)</p>
        <p class="text-black mb-0 text-lg font-bold">Plantel NAVOLATO 115</p>
        <p class="text-black mb-6 text-lg font-bold">Registro de Alumnos</p>

        <div id="login-container" class="transition-all duration-300">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800">Iniciar Sesión</h2>
            <input type="text" id="username-input" placeholder="Usuario" class="w-full p-3 mb-4 text-center text-lg rounded-xl border-2 border-gray-300 focus:outline-none focus:border-blue-500 transition-all duration-300">
            <input type="password" id="password-input" placeholder="Contraseña" class="w-full p-3 mb-4 text-center text-lg rounded-xl border-2 border-gray-300 focus:outline-none focus:border-blue-500 transition-all duration-300">
            <button id="login-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-xl transition-all duration-300">
                Acceder
            </button>
            <div id="login-message-box" class="min-h-[4rem] flex items-center justify-center p-4 rounded-lg font-medium transition-all duration-300 text-sm mt-4">
                <span class="text-gray-600">Por favor, ingresa tus credenciales.</span>
            </div>
        </div>

        <div id="main-app-container" style="display: none;">
            <div id="id-input-container" class="transition-all duration-300">
                <input type="text" id="student-id-input" placeholder="Ingresa el ID del alumno" class="w-full p-3 mb-4 text-center text-lg rounded-xl border-2 border-gray-300 focus:outline-none focus:border-blue-500 transition-all duration-300">
                <button id="submit-id-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-xl transition-all duration-300">
                    Verificar ID
                </button>
            </div>

            <div id="video-container" class="relative w-full aspect-video overflow-hidden rounded-xl shadow-inner mb-6 bg-gray-200 flex items-center justify-center border-4 border-gray-300" style="display: none;">
                <video id="video-feed" autoplay muted playsinline class="w-full h-full object-cover rounded-xl"></video>
                <div id="loader" class="absolute text-blue-600 font-semibold text-lg flex flex-col items-center justify-center bg-white bg-opacity-80 p-6 rounded-xl shadow-lg" style="display: none;">
                    <svg class="animate-spin -ml-1 mr-3 h-8 w-8 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span>Cargando...</span>
                </div>
            </div>

            <div id="message-box" class="min-h-[4rem] flex items-center justify-center p-4 rounded-lg font-medium transition-all duration-300 text-sm mt-4">
                <span class="text-gray-600">Ingresa un ID para comenzar.</span>
            </div>
            
            <button id="cancel-btn" class="hidden w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-xl transition-all duration-300 mt-4">
                Cancelar
            </button>

            <button id="logout-btn" class="mt-4 w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-xl transition-all duration-300">
                Cerrar Sesión
            </button>
        </div>

        <p class="mt-6 text-xs text-gray-500 text-center">
            App creada por: Nick Monarrez
        </p>
    </div>

    <div id="logout-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-semibold mb-4 text-gray-800">Confirmar Cierre de Sesión</h3>
            <p class="mb-4">Por favor, ingresa la contraseña para confirmar.</p>
            <input type="password" id="logout-password-input" placeholder="Contraseña" class="w-full p-3 mb-4 text-center text-lg rounded-xl border-2 border-gray-300 focus:outline-none focus:border-blue-500 transition-all duration-300">
            <div class="flex justify-end gap-2">
                <button id="cancel-logout-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-xl transition-all duration-300">
                    Cancelar
                </button>
                <button id="confirm-logout-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-xl transition-all duration-300">
                    Confirmar
                </button>
            </div>
            <div id="logout-message-box" class="min-h-[2rem] flex items-center justify-center p-2 rounded-lg font-medium transition-all duration-300 text-xs mt-2">
                <span class="text-gray-600"></span>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.1/dist/face-api.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const video = document.getElementById('video-feed');
            const messageBox = document.getElementById('message-box');
            const loader = document.getElementById('loader');
            const idInputContainer = document.getElementById('id-input-container');
            const studentIdInput = document.getElementById('student-id-input');
            const submitIdBtn = document.getElementById('submit-id-btn');
            const videoContainer = document.getElementById('video-container');
            const cancelBtn = document.getElementById('cancel-btn');

            // New login elements
            const loginContainer = document.getElementById('login-container');
            const mainAppContainer = document.getElementById('main-app-container');
            const usernameInput = document.getElementById('username-input');
            const passwordInput = document.getElementById('password-input');
            const loginBtn = document.getElementById('login-btn');
            const loginMessageBox = document.getElementById('login-message-box');

            // New logout elements
            const logoutBtn = document.getElementById('logout-btn');
            const logoutModal = document.getElementById('logout-modal');
            const confirmLogoutBtn = document.getElementById('confirm-logout-btn');
            const cancelLogoutBtn = document.getElementById('cancel-logout-btn');
            const logoutPasswordInput = document.getElementById('logout-password-input');
            const logoutMessageBox = document.getElementById('logout-message-box');

            let videoStream = null;
            let currentStudentId = null;
            let currentStudentName = null;
            let detectionTimeout = null;
            
            const MODELS_URL = 'https://raw.githubusercontent.com/NickMonarrez/aplicacion-asistencia/main/modelos';
            const APP_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzVUgqsLrTL5QI1ppQpqrCIstg9x-EDuA5xdrqF15Q8dnd8KvO-Zeu7xcNingbo_ctw/exec'; // <-- REEMPLAZA ESTO CON TU URL

            // Hardcoded credentials as requested by the user
            const CORRECT_USERNAME = 'ConalepNAVOLATO115*';
            const CORRECT_PASSWORD = 'Orientacioneducativa115*';

            const showMessage = (message, type, targetBox) => {
                const box = targetBox || messageBox;
                let classes = "min-h-[4rem] flex items-center justify-center p-4 rounded-lg font-medium transition-all duration-300 text-sm";
                switch (type) {
                    case 'success':
                        classes += " bg-green-100 text-green-700 border border-green-200";
                        break;
                    case 'error':
                        classes += " bg-red-100 text-red-700 border border-red-200";
                        break;
                    case 'info':
                        classes += " bg-blue-100 text-blue-700 border border-blue-200";
                        break;
                    default:
                        classes += " bg-gray-200 text-gray-600";
                        break;
                }
                box.className = classes;
                box.innerHTML = `<span>${message}</span>`;
            };

            const startVideo = async () => {
                try {
                    videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
                    video.srcObject = videoStream;
                    await new Promise((resolve) => video.onloadedmetadata = resolve);
                    video.play();
                    console.log("Camera started.");
                    return true;
                } catch (err) {
                    console.error("Error accessing camera:", err);
                    showMessage("No se pudo acceder a la cámara. Por favor, asegúrate de haber concedido los permisos.", "error");
                    return false;
                }
            };

            const stopVideo = () => {
                if (videoStream) {
                    videoStream.getTracks().forEach(track => track.stop());
                    videoStream = null;
                    video.srcObject = null;
                }
            };

            const loadModels = async () => {
                try {
                    await faceapi.nets.tinyFaceDetector.loadFromUri(MODELS_URL);
                    await faceapi.nets.faceLandmark68Net.loadFromUri(MODELS_URL);
                    await faceapi.nets.faceRecognitionNet.loadFromUri(MODELS_URL);
                    console.log("AI models loaded successfully.");
                } catch (e) {
                    console.error("Error loading AI models:", e);
                    throw new Error(`Error loading AI models. ${e.message}`);
                }
            };

            // MODIFIED: Uses fetch to communicate with Apps Script
            const getStudentName = async (studentId) => {
                const response = await fetch(`${APP_SCRIPT_URL}?studentId=${encodeURIComponent(studentId)}`);
                const data = await response.json();
                return data.name;
            };

            // MODIFIED: Uses fetch to communicate with Apps Script
            const registerFaceDescriptor = async (studentId, descriptor) => {
                const response = await fetch(APP_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        studentId: studentId,
                        descriptor: descriptor
                    })
                });

                const data = await response.json();
                if (!data.success) {
                    throw new Error(data.message);
                }
            };

            const captureFaceAndRegister = async () => {
                try {
                    const detections = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions())
                        .withFaceLandmarks()
                        .withFaceDescriptor();

                    if (detections && detections.descriptor) {
                        clearTimeout(detectionTimeout);
                        showMessage(`Rostro de ${currentStudentName} detectado. Registrando rasgos faciales...`, "info");
                        
                        const descriptorArray = Array.from(detections.descriptor);
                        const descriptorJson = JSON.stringify(descriptorArray);

                        await registerFaceDescriptor(currentStudentId, descriptorJson);
                        
                        showMessage(`¡Rasgos faciales de ${currentStudentName} registrados con éxito! ✅`, "success");
                        
                        setTimeout(() => {
                            resetApp();
                        }, 3000);
                    } else {
                        detectionTimeout = setTimeout(captureFaceAndRegister, 100);
                    }
                } catch (e) {
                    console.error("Error during face detection:", e);
                    showMessage(`Error: ${e.message}. Intenta de nuevo.`, "error");
                    setTimeout(() => {
                        resetApp();
                    }, 3000);
                }
            };

            const resetApp = () => {
                clearTimeout(detectionTimeout);
                stopVideo();
                videoContainer.style.display = 'none';
                cancelBtn.style.display = 'none';
                idInputContainer.style.display = 'block';
                studentIdInput.value = '';
                currentStudentId = null;
                currentStudentName = null;
                showMessage("Ingresa un nuevo ID para registrar.", "info");
            };

            const handleLogout = () => {
                resetApp(); // Reset the app state
                loginContainer.style.display = 'block';
                mainAppContainer.style.display = 'none';
                usernameInput.value = '';
                passwordInput.value = '';
                showMessage("Por favor, ingresa tus credenciales.", null, loginMessageBox);
            };

            const initializeAppContent = async () => {
                loader.style.display = 'flex';
                showMessage("Cargando modelos de IA...", "info");
                try {
                    await loadModels();
                    loader.style.display = 'none';
                    showMessage("Modelos de IA cargados. Ingresa el ID del alumno.", "info");
                    
                    await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
                    
                } catch (error) {
                    console.error("Error starting the application:", error);
                    loader.style.display = 'none';
                    showMessage(`Error: ${error.message || error}. Revisa tu conexión a internet o los permisos de la cámara.`, "error");
                }
            };

            const findStudent = async (id) => {
                const name = await getStudentName(id);
                if (name) {
                    return { name: name, id: id };
                }
                return null;
            };

            // Event Listeners
            loginBtn.addEventListener('click', () => {
                const username = usernameInput.value.trim();
                const password = passwordInput.value.trim();

                if (username === CORRECT_USERNAME && password === CORRECT_PASSWORD) {
                    showMessage("Credenciales correctas. Iniciando aplicación...", "success", loginMessageBox);
                    loginContainer.style.display = 'none';
                    mainAppContainer.style.display = 'block';
                    initializeAppContent();
                } else {
                    showMessage("Usuario o contraseña incorrectos.", "error", loginMessageBox);
                }
            });

            passwordInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    loginBtn.click();
                }
            });
            
            submitIdBtn.addEventListener('click', async () => {
                const id = studentIdInput.value.trim();
                if (id === '') {
                    showMessage("Por favor, ingresa un ID válido.", "error");
                    return;
                }

                showMessage("Verificando ID...", "info");
                
                const foundStudent = await findStudent(id);

                if (foundStudent && foundStudent.name) {
                    currentStudentId = foundStudent.id;
                    currentStudentName = foundStudent.name;
                    showMessage(`ID verificado. ¡Hola, ${currentStudentName}! Por favor, mira a la cámara.`, "success");
                    idInputContainer.style.display = 'none';
                    videoContainer.style.display = 'flex';
                    cancelBtn.style.display = 'block';
                    const videoStarted = await startVideo();
                    if (videoStarted) {
                        captureFaceAndRegister(); 
                    }
                } else {
                    showMessage("ID de alumno no encontrado. Por favor, verifica el ID e intenta de nuevo.", "error");
                    currentStudentId = null;
                }
            });

            cancelBtn.addEventListener('click', resetApp);
            
            logoutBtn.addEventListener('click', () => {
                logoutModal.classList.remove('hidden');
                logoutPasswordInput.value = '';
                showMessage("", null, logoutMessageBox);
            });

            confirmLogoutBtn.addEventListener('click', () => {
                const logoutPassword = logoutPasswordInput.value.trim();
                if (logoutPassword === CORRECT_PASSWORD) {
                    logoutModal.classList.add('hidden');
                    handleLogout();
                } else {
                    showMessage("Contraseña incorrecta.", "error", logoutMessageBox);
                }
            });

            cancelLogoutBtn.addEventListener('click', () => {
                logoutModal.classList.add('hidden');
            });

            // Initial app setup
            showMessage("Por favor, ingresa tus credenciales.", null, loginMessageBox);
        });
    </script>
</body>
</html>